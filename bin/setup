#!/usr/bin/env ruby

# This is the developer setup script. To install on a production server, see install.sh
# Based on https://github.com/mattbrictson/rails-template/blob/master/bin/setup

def setup!
  within_project_root do
    check_ruby_version
    run  "gem install bundler --no-document --conservative"
    run  "bundle install"

    puts "Setting up initial default values for your development environment. You can just hit return for most of these, to use default values.\n"
    puts "First the general environmental settings for all environments:\n"
    run "bin/conf_creator.sh .env"

    puts "Now the settings for the development environment:\n"
    run "bin/conf_creator.sh .env.development"

    puts "Now the settings for the test environment:\n"
    run "bin/conf_creator.sh .env.test"

    check_for_mysql

    run("bin/rake db:drop db:create db:migrate db:test:prepare db:seed")
  end
end

def check_for_mysql
  command = ["begin"]
  command << %q|ActiveRecord::Base.connection.select_value("SELECT 1")|
  command << %q|rescue Mysql2::Error|
  command << %q|warn "We were unable to connect to your database. Please check that you have MySQL installed and that it is currently running (#{$!.message})"|
  command << %q|else| 
  command << %q|puts "Successfully connected to MySQL"|
  command << %q|end|

  run "bin/rails runner '#{command.join(";")}'"
end

def within_project_root
  Dir.chdir(File.expand_path("../",__dir__)) do
    yield
  end
end

def check_ruby_version
  desired_version = IO.read(".ruby-version").strip
  running_version = RUBY_VERSION

  unless desired_version == running_version
    warn "You are running Ruby #{running_version} but Coyote is developed with #{desired_version} (found in .ruby-version). This may cause problems."
  end
end

def run(command)
  puts "run '#{command}'"

  with_clean_bundler_env do
    system(command) || abort("#{command} exited with non-zero status")
  end
end

def with_clean_bundler_env
  if defined?(Bundler)
    Bundler.with_clean_env { yield }
  else
    yield
  end
end

setup!
